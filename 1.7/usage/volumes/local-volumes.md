---
layout: page
post_title: Local Volumes
menu_order: 0
---

<p>Use local volumes when speed is crucial for your app, or when you have a performance-sensitive app that needs exclusive access to a disk.</p>

<h3>Mount Disk Resources</h3>

<h4>Overview</h4>

<p>Mesos Volume Mounts give services the ability to reserve dedicated disk space throughout the cluster. This is particularly useful for stateful services like Kafka and Cassandra.</p>

<p>In DC/OS it is possible to configure <a href="http://mesos.apache.org/documentation/latest/multiple-disk/">Mesos Mount disk resources</a> across the cluster by simply mounting storage resources on Agents using a well-known path. When a DC/OS agent starts for the first time it will scan for volumes matching the pattern <code>/dcos/volumeN</code>, where N is an integer, and automatically configure the Mesos Agent to offer these disk resources to other services.</p>

<h5>Example using loopback device</h5>

<p>The example below shows how to add a disk resource to a DC/OS agent post-install on a running cluster. The same steps can be used pre-install, but in that scenario it is not necessary to stop services or clear the Mesos Agent state.</p>

<p><strong><em>Warning:</em></strong> This will terminate any running tasks or services on the node.</p>

<ol>
<li><p>Connect to an agent in the cluster with SSH</p></li>
<li><p>Examine the current Mesos Agent resource state</p>

<p>Note there are no references yet for <code>/dcos/volume0</code>.</p>

<p>~~~bash
$ cat /var/lib/dcos/mesos-resources</p>

<h1>Generated by make_disk_resources.py on 2016-05-05 17:04:29.868595</h1>

<p>#</p>

<p>MESOS_RESOURCES='[{"ranges": {"range": [{"end": 21, "begin": 1}, {"end": 5050, "begin": 23}, {"end": 32000, "begin": 5052}]}, "type": "RANGES", "name": "ports"}, {"role": "*", "type": "SCALAR", "name": "disk", "scalar": {"value": 47540}}]'
~~~</p></li>
<li><p>Stop the Mesos Agent</p>

<p>On a Private Agent:</p>

<p><code>bash
$ sudo systemctl stop dcos-mesos-slave.service</code></p>

<p>On a Public Agent:</p>

<p><code>bash
$ sudo systemctl stop dcos-mesos-slave-public.service</code></p></li>
<li><p>Clear Mesos Agent state</p>

<p>Remove Volume Mount Discovery resource state</p>

<p><code>bash
$ sudo rm -f /var/lib/dcos/mesos-resources</code></p>

<p>Remove Mesos Agent checkpoint state</p>

<p><code>bash
$ sudo rm -f /var/lib/mesos/slave/meta/slaves/latest</code></p></li>
<li><p>Create a 200MB loopback device</p>

<p>This is suitable for testing purposes only. Mount volumes must have at least 200MB of free space available. 100MB on each volume will be reserved by DC/OS and is not available for other services.</p>

<p><code>bash
$ sudo mkdir -p /dcos/volume0
$ sudo dd if=/dev/zero of=/root/volume0.img bs=1M count=200
$ sudo losetup /dev/loop0 /root/volume0.img
$ sudo mkfs -t ext4 /dev/loop0
$ sudo losetup -d /dev/loop0</code></p></li>
<li><p>Create fstab entry and mount</p>

<p>Ensure the volume is mounted automatically at boot time. Something similar could also be done with a Systemd Mount unit.</p>

<p><code>bash
$ echo "/root/volume0.img /dcos/volume0 auto loop 0 2" | sudo tee -a /etc/fstab
$ sudo mount /dcos/volume0</code></p></li>
<li><p>Reboot</p>

<p><code>bash
$ sudo reboot</code></p></li>
<li><p>SSH to Mesos Agent and Verify new resource state</p>

<p>Look through the journald logs for references to the new volume <code>/dcos/volume0</code>. In particular, there should be an entry for the Mesos Agent starting up and the new volume0 Disk Mount resource.</p>

<p><code>bash
$ journalctl -b | grep '/dcos/volume0'
May 05 19:18:40 dcos-agent-public-01234567000001 systemd[1]: Mounting /dcos/volume0...
May 05 19:18:42 dcos-agent-public-01234567000001 systemd[1]: Mounted /dcos/volume0.
May 05 19:18:46 dcos-agent-public-01234567000001 make_disk_resources.py[888]: Found matching mounts : [('/dcos/volume0', 74)]
May 05 19:18:46 dcos-agent-public-01234567000001 make_disk_resources.py[888]: Generated disk resources map: [{'name': 'disk', 'type': 'SCALAR', 'disk': {'source': {'mount': {'root': '/dcos/volume0'}, 'type': 'MOUNT'}}, 'role': '*', 'scalar': {'value': 74}}, {'name': 'disk', 'type': 'SCALAR', 'role': '*', 'scalar': {'value': 47540}}]
May 05 19:18:58 dcos-agent-public-01234567000001 mesos-slave[1891]: " --oversubscribed_resources_interval="15secs" --perf_duration="10secs" --perf_interval="1mins" --port="5051" --qos_correction_interval_min="0ns" --quiet="false" --recover="reconnect" --recovery_timeout="15mins" --registration_backoff_factor="1secs" --resources="[{"name": "ports", "type": "RANGES", "ranges": {"range": [{"end": 21, "begin": 1}, {"end": 5050, "begin": 23}, {"end": 32000, "begin": 5052}]}}, {"name": "disk", "type": "SCALAR", "disk": {"source": {"mount": {"root": "/dcos/volume0"}, "type": "MOUNT"}}, "role": "*", "scalar": {"value": 74}}, {"name": "disk", "type": "SCALAR", "role": "*", "scalar": {"value": 47540}}]" --revocable_cpu_low_priority="true" --sandbox_directory="/mnt/mesos/sandbox" --slave_subsystems="cpu,memory" --strict="true" --switch_user="true" --systemd_enable_support="true" --systemd_runtime_directory="/run/systemd/system" --version="false" --work_dir="/var/lib/mesos/slave"</code></p></li>
</ol>

<h5>Cloud Provider Resources</h5>

<p>Cloud provider storage services are typically used to back DC/OS Mount Volumes. The following reference material may be useful when desiging a production DC/OS deployment:</p>

<ul>
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html">Amazon: EBS</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-linux-about-disks-vhds/">Azure: About disks and VHDs for Azure virtual machines</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/storage-introduction/">Azure: Introduction to Microsoft Azure storage</a> (see <em>Blob Storage</em> section on Page blobs)</li>
</ul>

<h5>Best Practices</h5>

<p>Disk Mount Resources are primarily for stateful services like Kafka and Cassandra which can benefit from having dedicated storage available throughout the cluster. Any service utilizing a Disk Mount Resource will have exclusive access to the reserved resource. However, it is still important to take into consideration performance and reliability requirements for the service. The performance of a Disk Mount Resource is based on the characteristic of the underlying storage and DC/OS does not provide any data replication services. With this in mind:</p>

<ul>
<li>Use Disk Mount Resources with stateful services which have strict storage requirements.</li>
<li>Carefully consider the filesystem type, storage media (network attached, SSD, etc.) and volume characteristics (RAID levels, sizing, etc.) based on the storage needs and requirements of the stateful service.</li>
<li>Label Mesos Agents using a Mesos Attribute which reflects the characteristics of the Agent's Disk Mounts, e.g. IOPS200, RAID1, etc.</li>
<li>Associate stateful services with storage Agents using Mesos Attribute constraints.</li>
<li>Consider isolating demanding storage services to dedicated storage Agents, since the filesystem page cache is a host level shared resource.</li>
<li>Ensure all services using Disk Mount Resources are designed handle the permanent loss of one or more Disk Mount Resources. Services are still responsible to manage data replication and retention, graceful recovery from failed Agents, and backups of critical service state.</li>
</ul>
